<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teacher Dashboard</title>
<link rel="stylesheet" href="style.css">

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script src="firebase.js"></script>
</head>
<body>

<div class="sidebar">
  <h2>ğŸ‘©â€ğŸ« Teacher</h2>
  <a href="#" class="active">My Classes</a>
  <a href="#" onclick="generateDefaulter()">Defaulter List</a>
  <a href="#" class="logout-btn" onclick="firebase.auth().signOut().then(()=>window.location='index.html')">Logout</a>
</div>

<div class="main-content">
  <h2>Your Classes</h2>
  <div id="class-list" class="card-container"></div>

  <div id="student-section" class="hidden">
    <h3 id="class-title"></h3>
    <div id="students-list"></div>
  </div>
</div>

<script>
let currentTeacherId = "";
let currentClass = "";

firebase.auth().onAuthStateChanged(user=>{
  if(!user) window.location='login.html';
  currentTeacherId = user.uid;
  loadClasses();
});

function loadClasses(){
  database.ref(`teachers/${currentTeacherId}/classes`).once('value', snap=>{
    const classListDiv=document.getElementById("class-list");
    classListDiv.innerHTML="";
    if(!snap.exists()){ classListDiv.innerHTML="<p>No classes assigned</p>"; return; }
    snap.forEach(cls=>{
      const div=document.createElement("div");
      div.className="card";
      div.innerHTML=`<h3>${cls.key}</h3><button class="btn" onclick="viewClass('${cls.key}')">View Students</button>`;
      classListDiv.appendChild(div);
    });
  });
}

function viewClass(className){
  currentClass=className;
  document.getElementById("class-title").textContent=`Class: ${className}`;
  document.getElementById("student-section").classList.remove("hidden");
  database.ref(`teachers/${currentTeacherId}/classes/${className}/students`).once("value", snap=>{
    const studentsList=document.getElementById("students-list");
    studentsList.innerHTML="";
    snap.forEach(snapS=>{
      const s=snapS.val();
      const div=document.createElement("div");
      div.innerHTML=`<span>${s.name} (Roll: ${snapS.key})</span>
        <button class="btn present" onclick="markAttendance('${snapS.key}','present',this)">Present</button>
        <button class="btn absent" onclick="markAttendance('${snapS.key}','absent',this)">Absent</button>`;
      div.style.margin="10px 0";
      studentsList.appendChild(div);
    });
  });
}

function markAttendance(roll,status,btn){
  const date=new Date().toISOString().split('T')[0];
  database.ref(`teachers/${currentTeacherId}/classes/${currentClass}/attendance/${date}/${roll}`).set(status);
  const parent=btn.parentElement;
  parent.querySelectorAll("button").forEach(b=>b.style.background="gray");
  btn.style.background=status==="present"?"#4CAF50":"#f44336";
}

function generateDefaulter(){
  const date=prompt("Enter date (YYYY-MM-DD):", new Date().toISOString().split('T')[0]);
  if(!date) return;
  database.ref(`teachers/${currentTeacherId}/classes/${currentClass}/attendance/${date}`).once("value", snap=>{
    if(!snap.exists()){ alert("No attendance"); return; }
    let defaulters=[];
    snap.forEach(snapS=>{ if(snapS.val()==="absent") defaulters.push(snapS.key); });
    alert(`Defaulters: ${defaulters.join(", ") || "None"}`);
  });
}
</script>
</body>
</html>
